{#- Based upon ignition config generated by https://opensuse.github.io/fuel-ignition/edit -#}
{%- set _ssh_keys = [] -%}
{%- set _ssh_key_files = [] -%}
{%- if setup_ssh_key is defined -%}
{%-   set _ = _ssh_key_files.append([setup_ssh_key.path.local, setup_ssh_key.files[1].file] | join('/')) -%}
{%- endif -%}
{%- if ssh_pub_keys is defined -%}
{%-   set _ = _ssh_key_files.extend(ssh_pub_keys.files | default([])) -%}
{%-   for _kc in ssh_pub_keys.strings | default([]) -%}
{%-     set _ = _ssh_keys.append(_kc) -%}
{%-   endfor -%}
{%- endif -%}
{%- for _kf in _ssh_key_files -%}
{%-   set _ = _ssh_keys.append(lookup('file', _kf)) -%}
{%- endfor -%}
{%- set unique_ssh_keys = _ssh_keys | sort | unique -%}
{
  "ignition": {
    "version": "3.2.0"
  },
  "passwd": {
    "users": [
      {
        "name": "root",
	{# Password is '{AlpTestEnv2023}' #}
        "passwordHash": "$2a$10$8cSI2wefsk.R4ekovBNGsOsP4HksJpdr2vxYQc37.VmIotkkO0uW6",
        "sshAuthorizedKeys": {{ unique_ssh_keys | to_json }}
      },
      {
        "name": "testenv",
	{# Password is '{AlpTestEnv2023}' #}
        "passwordHash": "$2a$10$z82/skiiqLBu.eAvXEHy2.lZLGJscUkAdmE4NRUqGqHHYP0.3DJmi",
        "sshAuthorizedKeys": {{ unique_ssh_keys | to_json }}
      }
    ]
  },
  "storage": {
    "filesystems": [
      {
        "device": "/dev/disk/by-label/ROOT",
        "format": "btrfs",
        "mountOptions": [
          "subvol=/@/home"
        ],
        "path": "/home",
        "wipeFilesystem": false
      }
    ],
    "files": [
      {
        "path": "/etc/hostname",
	"mode": 420,
	"overwrite": true,
	"contents": {
	  "source": "data:text/plain;charset=utf-8;base64,{{ alp_vm.name | b64encode }}"
	}
      },
      {
        "path": "/etc/sudoers.d/{{ vm_mgmt_user | default('testenv') }}",
        "mode": 420,
        "overwrite": true,
        "contents": {
          "source": "data:text/plain;charset=utf-8;base64,{{ ((vm_mgmt_user | default('testenv')) ~ ' ALL=(ALL:ALL) NOPASSWD:ALL') | b64encode }}"
        }
{% for f in setup_ssh_key.files %}
      },
      {
        "path": "/home/{{ vm_mgmt_user | default('testenv') }}/.ssh/{{ f.file }}",
        "mode": {{ f.mode_decimal }},
        "overwrite": true,
        "contents": {
          "source": "data:text/plain;charset=utf-8;base64,{{ lookup('file', [setup_ssh_key.path.local, f.file] | join('/')) | b64encode }}"
        }
{% endfor %}
      }
    ]
  }
}
